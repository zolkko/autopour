!function(t){if(typeof define==="function"&&define.amd){define(["underscore","jquery"],t)}else if(typeof exports==="object"){var e,i;try{e=require("underscore")}catch(r){}try{i=require("jquery")}catch(r){}t(e,i)}else{t(this._,this.jQuery||this.Zepto||this.ender||this.$)}}(function(t,e){"use strict";var i=typeof exports==="object";var r=i?exports:window;var n=r.Backbone;var s=r.Exoskeleton;var a=i?exports:r.Exoskeleton=r.Backbone={};var o=a.utils=t=t||{};a.$=e;var u=[];var l=u.push;var h=u.slice;var c={}.toString;a.noConflict=function(){r.Backbone=n;r.Exoskeleton=s;return this};a.emulateHTTP=false;a.emulateJSON=false;a.extend=function(e,i){var r=this;var n;if(e&&hasOwnProperty.call(e,"constructor")){n=e.constructor}else{n=function(){return r.apply(this,arguments)}}t.extend(n,r,i);var s=function(){this.constructor=n};s.prototype=r.prototype;n.prototype=new s;if(e)t.extend(n.prototype,e);n.__super__=r.prototype;return n};var f=function(){throw new Error('A "url" property or function must be specified')};var d=function(t,e){var i=e.error;e.error=function(r){if(i)i(t,r,e);t.trigger("error",t,r,e)}};var p=function(e){return typeof t[e]==="function"};o.result=function F(t,e){var i=t?t[e]:undefined;return typeof i==="function"?t[e]():i};o.defaults=function V(t){h.call(arguments,1).forEach(function(e){for(var i in e)if(t[i]===undefined)t[i]=e[i]});return t};o.extend=function G(t){h.call(arguments,1).forEach(function(e){for(var i in e)t[i]=e[i]});return t};var v={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};o.escape=function X(t){return t==null?"":String(t).replace(/[&<>"']/g,function(t){return v[t]})};o.sortBy=function(t,e,i){var r=typeof e==="function"?e:function(t){return t[e]};return t.map(function(t,e,n){return{value:t,index:e,criteria:r.call(i,t,e,n)}}).sort(function(t,e){var i=t.criteria;var r=e.criteria;if(i!==r){if(i>r||i===void 0)return 1;if(i<r||r===void 0)return-1}return t.index-e.index}).map(function(t){return t.value})};var g=0;o.uniqueId=function Q(t){var e=++g+"";return t?t+e:e};var m=function(t,e,i,r){if(t===e)return t!==0||1/t==1/e;if(t==null||e==null)return t===e;var n=c.call(t);if(n!=c.call(e))return false;switch(n){case"[object String]":return t==String(e);case"[object Number]":return t!==+t?e!==+e:t===0?1/t===1/e:t===+e;case"[object Date]":case"[object Boolean]":return+t==+e;case"[object RegExp]":return t.source==e.source&&t.global==e.global&&t.multiline==e.multiline&&t.ignoreCase==e.ignoreCase}if(typeof t!="object"||typeof e!="object")return false;var s=i.length;while(s--){if(i[s]==t)return r[s]==e}var a=t.constructor,o=e.constructor;if(a!==o&&!(typeof a==="function"&&a instanceof a&&typeof o==="function"&&o instanceof o)){return false}i.push(t);r.push(e);var u=0,l=true;if(n==="[object Array]"){u=t.length;l=u===e.length;if(l){while(u--){if(!(l=m(t[u],e[u],i,r)))break}}}else{for(var h in t){if(hasOwnProperty.call(t,h)){u++;if(!(l=hasOwnProperty.call(e,h)&&m(t[h],e[h],i,r)))break}}if(l){for(h in e){if(hasOwnProperty.call(e,h)&&!u--)break}l=!u}}i.pop();r.pop();return l};o.isEqual=function(t,e){return m(t,e,[],[])};o.matchesSelector=function(){if(typeof document==="undefined")return;var t="MatchesSelector";var e=document.createElement("div");var i;["matches","webkit"+t,"moz"+t,"ms"+t].some(function(t){var r=t in e;i=t;return r});if(!i)throw new Error("Element#matches is not supported");return function(t,e){return t[i](e)}}();o.ajax=function(){var t=/^(?:application|text)\/xml/;var e=/^application\/json/;var i=function(i,r){if(i==null)i=r.getResponseHeader("content-type");if(t.test(i)){return r.responseXML}else if(e.test(i)){return JSON.parse(r.responseText)}else{return r.responseText}};var r=function(t){return t.status>=200&&t.status<300||t.status===304||t.status===0&&window.location.protocol==="file:"};var n=function(t,e,n){return function(){if(t.readyState!==4)return;var s=t.status;var a=i(e.headers&&e.headers.Accept,t);if(r(t)){if(e.success)e.success(a);if(n)n.resolve(a)}else{var o=new Error("Server responded with a status of "+s);if(e.error)e.error(t,s,o);if(n)n.reject(t)}}};return function(t){if(t==null)throw new Error("You must provide options");if(t.type==null)t.type="GET";var e=new XMLHttpRequest;var i=a.Deferred&&a.Deferred();if(t.contentType){if(t.headers==null)t.headers={};t.headers["Content-Type"]=t.contentType}if(t.credentials)t.withCredentials=true;e.addEventListener("readystatechange",n(e,t,i));e.open(t.type,t.url,true);if(t.headers)for(var r in t.headers){e.setRequestHeader(r,t.headers[r])}if(t.beforeSend)t.beforeSend(e);e.send(t.data);return i?i.promise:undefined}}();var y=a.Events={on:function(t,e,i){if(!w(this,"on",t,[e,i])||!e)return this;this._events||(this._events={});var r=this._events[t]||(this._events[t]=[]);r.push({callback:e,context:i,ctx:i||this});return this},once:function(t,e,i){if(!w(this,"once",t,[e,i])||!e)return this;var r=this;var n;var s=function(){if(n)return;n=true;r.off(t,s);e.apply(this,arguments)};s._callback=e;return this.on(t,s,i)},off:function(t,e,i){var r,n,s,a,o,u,l,h;if(!this._events||!w(this,"off",t,[e,i]))return this;if(!t&&!e&&!i){this._events=undefined;return this}a=t?[t]:Object.keys(this._events);for(o=0,u=a.length;o<u;o++){t=a[o];if(s=this._events[t]){this._events[t]=r=[];if(e||i){for(l=0,h=s.length;l<h;l++){n=s[l];if(e&&e!==n.callback&&e!==n.callback._callback||i&&i!==n.context){r.push(n)}}}if(!r.length)delete this._events[t]}}return this},trigger:function(t){if(!this._events)return this;var e=h.call(arguments,1);if(!w(this,"trigger",t,e))return this;var i=this._events[t];var r=this._events.all;if(i)_(i,e);if(r)_(r,arguments);return this},stopListening:function(t,e,i){var r=this._listeningTo;if(!r)return this;var n=!e&&!i;if(!i&&typeof e==="object")i=this;if(t)(r={})[t._listenId]=t;for(var s in r){t=r[s];t.off(e,i,this);if(n||!Object.keys(t._events).length){delete this._listeningTo[s]}}return this}};var b=/\s+/;var w=function(t,e,i,r){if(!i)return true;var n;if(typeof i==="object"){for(var s in i){n=[s,i[s]];l.apply(n,r);t[e].apply(t,n)}return false}if(b.test(i)){var a=i.split(b);for(var o=0,u=a.length;o<u;o++){n=[a[o]];l.apply(n,r);t[e].apply(t,n)}return false}return true};var _=function(t,e){var i,r=-1,n=t.length,s=e[0],a=e[1],o=e[2];switch(e.length){case 0:while(++r<n)(i=t[r]).callback.call(i.ctx);return;case 1:while(++r<n)(i=t[r]).callback.call(i.ctx,s);return;case 2:while(++r<n)(i=t[r]).callback.call(i.ctx,s,a);return;case 3:while(++r<n)(i=t[r]).callback.call(i.ctx,s,a,o);return;default:while(++r<n)(i=t[r]).callback.apply(i.ctx,e)}};var x={listenTo:"on",listenToOnce:"once"};Object.keys(x).forEach(function(e){var i=x[e];y[e]=function(e,r,n){var s=this._listeningTo||(this._listeningTo={});var a=e._listenId||(e._listenId=t.uniqueId("l"));s[a]=e;if(!n&&typeof r==="object")n=this;e[i](r,n,this);return this}});y.bind=y.on;y.unbind=y.off;var E=a.Model=function(e,i){var r=e||{};i||(i={});this.cid=t.uniqueId("c");this.attributes=Object.create(null);if(i.collection)this.collection=i.collection;if(i.parse)r=this.parse(r,i)||{};r=t.defaults({},r,t.result(this,"defaults"));this.set(r,i);this.changed=Object.create(null);this.initialize.apply(this,arguments)};t.extend(E.prototype,y,{changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(e){return t.extend(Object.create(null),this.attributes)},sync:function(){return a.sync.apply(this,arguments)},get:function(t){return this.attributes[t]},escape:function(e){return t.escape(this.get(e))},has:function(t){return this.get(t)!=null},set:function(e,i,r){var n,s,a,o,u,l,h,c;if(e==null)return this;if(typeof e==="object"){s=e;r=i}else{(s={})[e]=i}r||(r={});if(!this._validate(s,r))return false;a=r.unset;u=r.silent;o=[];l=this._changing;this._changing=true;if(!l){this._previousAttributes=t.extend(Object.create(null),this.attributes);this.changed={}}c=this.attributes,h=this._previousAttributes;if(this.idAttribute in s)this.id=s[this.idAttribute];for(n in s){i=s[n];if(!t.isEqual(c[n],i))o.push(n);if(!t.isEqual(h[n],i)){this.changed[n]=i}else{delete this.changed[n]}a?delete c[n]:c[n]=i}if(!u){if(o.length)this._pending=true;for(var f=0,d=o.length;f<d;f++){this.trigger("change:"+o[f],this,c[o[f]],r)}}if(l)return this;if(!u){while(this._pending){this._pending=false;this.trigger("change",this,r)}}this._pending=false;this._changing=false;return this},unset:function(e,i){return this.set(e,void 0,t.extend({},i,{unset:true}))},clear:function(e){var i={};for(var r in this.attributes)i[r]=void 0;return this.set(i,t.extend({},e,{unset:true}))},hasChanged:function(t){if(t==null)return!!Object.keys(this.changed).length;return hasOwnProperty.call(this.changed,t)},changedAttributes:function(e){if(!e)return this.hasChanged()?t.extend(Object.create(null),this.changed):false;var i,r=false;var n=this._changing?this._previousAttributes:this.attributes;for(var s in e){if(t.isEqual(n[s],i=e[s]))continue;(r||(r={}))[s]=i}return r},previous:function(t){if(t==null||!this._previousAttributes)return null;return this._previousAttributes[t]},previousAttributes:function(){return t.extend(Object.create(null),this._previousAttributes)},fetch:function(e){e=e?t.extend({},e):{};if(e.parse===void 0)e.parse=true;var i=this;var r=e.success;e.success=function(t){if(!i.set(i.parse(t,e),e))return false;if(r)r(i,t,e);i.trigger("sync",i,t,e)};d(this,e);return this.sync("read",this,e)},save:function(e,i,r){var n,s,a,o=this.attributes;if(e==null||typeof e==="object"){n=e;r=i}else{(n={})[e]=i}r=t.extend({validate:true},r);if(n&&!r.wait){if(!this.set(n,r))return false}else{if(!this._validate(n,r))return false}if(n&&r.wait){this.attributes=t.extend(Object.create(null),o,n)}if(r.parse===void 0)r.parse=true;var u=this;var l=r.success;r.success=function(e){u.attributes=o;var i=u.parse(e,r);if(r.wait)i=t.extend(n||{},i);if(i&&typeof i==="object"&&!u.set(i,r)){return false}if(l)l(u,e,r);u.trigger("sync",u,e,r)};d(this,r);s=this.isNew()?"create":r.patch?"patch":"update";if(s==="patch")r.attrs=n;a=this.sync(s,this,r);if(n&&r.wait)this.attributes=o;return a},destroy:function(e){e=e?t.extend({},e):{};var i=this;var r=e.success;var n=function(){i.trigger("destroy",i,i.collection,e)};e.success=function(t){if(e.wait||i.isNew())n();if(r)r(i,t,e);if(!i.isNew())i.trigger("sync",i,t,e)};if(this.isNew()){e.success();return false}d(this,e);var s=this.sync("delete",this,e);if(!e.wait)n();return s},url:function(){var e=t.result(this,"urlRoot")||t.result(this.collection,"url")||f();if(this.isNew())return e;return e+(e.charAt(e.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(t,e){return t},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(e){return this._validate({},t.extend(e||{},{validate:true}))},_validate:function(e,i){if(!i.validate||!this.validate)return true;e=t.extend(Object.create(null),this.attributes,e);var r=this.validationError=this.validate(e,i)||null;if(!r)return true;this.trigger("invalid",this,r,t.extend(i,{validationError:r}));return false}});if(t.keys){var j=["keys","values","pairs","invert","pick","omit"];j.filter(p).forEach(function(e){E.prototype[e]=function(){var i=h.call(arguments);i.unshift(this.attributes);return t[e].apply(t,i)}})}var k=a.Collection=function(e,i){i||(i={});if(i.model)this.model=i.model;if(i.comparator!==void 0)this.comparator=i.comparator;this._reset();this.initialize.apply(this,arguments);if(e)this.reset(e,t.extend({silent:true},i))};var O={add:true,remove:true,merge:true};var S={add:true,remove:false};t.extend(k.prototype,y,{model:typeof E==="undefined"?null:E,initialize:function(){},toJSON:function(t){return this.map(function(e){return e.toJSON(t)})},sync:function(){return a.sync.apply(this,arguments)},add:function(e,i){return this.set(e,t.extend({merge:false},i,S))},remove:function(t,e){var i=!Array.isArray(t);t=i?[t]:t.slice();e||(e={});var r,n,s,a;for(r=0,n=t.length;r<n;r++){a=t[r]=this.get(t[r]);if(!a)continue;delete this._byId[a.id];delete this._byId[a.cid];s=this.indexOf(a);this.models.splice(s,1);this.length--;if(!e.silent){e.index=s;a.trigger("remove",a,this,e)}this._removeReference(a)}return i?t[0]:t},set:function(e,i){i=t.defaults({},i,O);if(i.parse)e=this.parse(e,i);var r=!Array.isArray(e);e=r?e?[e]:[]:e.slice();var n,s,a,o,u,l,h;var c=i.at;var f=this.model;var d=this.comparator&&c==null&&i.sort!==false;var p=typeof this.comparator==="string"?this.comparator:null;var v=[],g=[],m={};var y=i.add,b=i.merge,w=i.remove;var _=!d&&y&&w?[]:false;for(n=0,s=e.length;n<s;n++){u=e[n];if(u instanceof E){a=o=u}else{a=u[f.prototype.idAttribute]}if(l=this.get(a)){if(w)m[l.cid]=true;if(b){u=u===o?o.attributes:u;if(i.parse)u=l.parse(u,i);l.set(u,i);if(d&&!h&&l.hasChanged(p))h=true}e[n]=l}else if(y){o=e[n]=this._prepareModel(u,i);if(!o)continue;v.push(o);o.on("all",this._onModelEvent,this);this._byId[o.cid]=o;if(o.id!=null)this._byId[o.id]=o}if(_)_.push(l||o)}if(w){for(n=0,s=this.length;n<s;++n){if(!m[(o=this.models[n]).cid])g.push(o)}if(g.length)this.remove(g,i)}if(v.length||_&&_.length){if(d)h=true;this.length+=v.length;if(c!=null){for(n=0,s=v.length;n<s;n++){this.models.splice(c+n,0,v[n])}}else{if(_)this.models.length=0;var x=_||v;for(n=0,s=x.length;n<s;n++){this.models.push(x[n])}}}if(h)this.sort({silent:true});if(!i.silent){for(n=0,s=v.length;n<s;n++){(o=v[n]).trigger("add",o,this,i)}if(h||_&&_.length)this.trigger("sort",this,i)}return r?e[0]:e},reset:function(e,i){i||(i={});for(var r=0,n=this.models.length;r<n;r++){this._removeReference(this.models[r])}i.previousModels=this.models;this._reset();e=this.add(e,t.extend({silent:true},i));if(!i.silent)this.trigger("reset",this,i);return e},push:function(e,i){return this.add(e,t.extend({at:this.length},i))},pop:function(t){var e=this.at(this.length-1);this.remove(e,t);return e},unshift:function(e,i){return this.add(e,t.extend({at:0},i))},shift:function(t){var e=this.at(0);this.remove(e,t);return e},slice:function(){return h.apply(this.models,arguments)},get:function(t){if(t==null)return void 0;return this._byId[t.id]||this._byId[t.cid]||this._byId[t]},at:function(t){return this.models[t]},where:function(t,e){if(!t||!Object.keys(t).length)return e?void 0:[];return this[e?"find":"filter"](function(e){for(var i in t){if(t[i]!==e.get(i))return false}return true})},findWhere:function(t){return this.where(t,true)},sort:function(t){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");t||(t={});if(typeof this.comparator==="string"||this.comparator.length===1){this.models=this.sortBy(this.comparator,this)}else{this.models.sort(this.comparator.bind(this))}if(!t.silent)this.trigger("sort",this,t);return this},pluck:function(t){return this.models.map(function(e){return e.get(t)})},fetch:function(e){e=e?t.extend({},e):{};if(e.parse===void 0)e.parse=true;var i=e.success;var r=this;e.success=function(t){var n=e.reset?"reset":"set";r[n](t,e);if(i)i(r,t,e);r.trigger("sync",r,t,e)};d(this,e);return this.sync("read",this,e)},create:function(e,i){i=i?t.extend({},i):{};if(!(e=this._prepareModel(e,i)))return false;if(!i.wait)this.add(e,i);var r=this;var n=i.success;i.success=function(t,e,i){if(i.wait)r.add(t,i);if(n)n(t,e,i)};e.save(null,i);return e},parse:function(t,e){return t},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0;this.models=[];this._byId={}},_prepareModel:function(e,i){if(e instanceof k.prototype.model){if(!e.collection)e.collection=this;return e}i=i?t.extend({},i):{};i.collection=this;var r=new this.model(e,i);if(!r.validationError)return r;this.trigger("invalid",this,r.validationError,i);return false},_removeReference:function(t){if(this===t.collection)delete t.collection;t.off("all",this._onModelEvent,this)},_onModelEvent:function(t,e,i,r){if((t==="add"||t==="remove")&&i!==this)return;if(t==="destroy")this.remove(e,r);if(e&&t==="change:"+e.idAttribute){delete this._byId[e.previous(e.idAttribute)];if(e.id!=null)this._byId[e.id]=e}this.trigger.apply(this,arguments)}});if(p("each")){var T=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","difference","indexOf","shuffle","lastIndexOf","isEmpty","chain"];T.filter(p).forEach(function(e){k.prototype[e]=function(){var i=h.call(arguments);i.unshift(this.models);return t[e].apply(t,i)}});var $=["groupBy","countBy","sortBy"];$.filter(p).forEach(function(e){k.prototype[e]=function(i,r){var n=typeof i==="function"?i:function(t){return t.get(i)};return t[e](this.models,n,r)}})}else{["forEach","map","filter","some","every","reduce","reduceRight","indexOf","lastIndexOf"].forEach(function(t){var e=Array.prototype[t];k.prototype[t]=function(t,i){return e.call(this.models,t,i)}});["sortBy"].forEach(function(e){k.prototype[e]=function(i,r){var n=typeof i==="function"?i:function(t){return t.get(i)};return t[e](this.models,n,r)}})}var N=/^(\S+)\s*(.*)$/;var A=["model","collection","el","id","attributes","className","tagName","events"];var H=a.View=function(e){this.cid=t.uniqueId("view");if(e)Object.keys(e).forEach(function(t){if(A.indexOf(t)!==-1)this[t]=e[t]},this);this._handlers=[];this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()};t.extend(H.prototype,y,{tagName:"div",$:function(t){return a.$?this.$el.find(t):this.findAll(t)},find:function(t){return this.el.querySelector(t)},findAll:function(t){return h.call(this.el.querySelectorAll(t))},initialize:function(){},render:function(){return this},remove:function(){if(a.$){this.$el.remove()}else if(this.el.parentNode){this.el.parentNode.removeChild(this.el)}this.stopListening();return this},setElement:function(t,e){if(a.$){if(this.$el)this.undelegateEvents();this.$el=t instanceof a.$?t:a.$(t);this.el=this.$el[0]}else{if(this.el)this.undelegateEvents();var i=typeof t==="string"?document.querySelector(t):t;this.el=i}if(e!==false)this.delegateEvents();return this},delegate:function(t,e,i){if(typeof e==="function"){i=e;e=null}if(typeof i!=="function"){throw new TypeError("View#delegate expects callback function")}var r=this.el;var n=i.bind(this);var s=e?function(t){for(var i=t.target;i&&i!==r;i=i.parentNode){if(o.matchesSelector(i,e)){t.delegateTarget=i;return n(t)}}}:n;r.addEventListener(t,s,false);this._handlers.push({eventName:t,selector:e,callback:i,handler:s});return s},undelegate:function(t,e,i){if(typeof e==="function"){i=e;e=null}var r=this.el;var n=this._handlers;var s=function(t){r.removeEventListener(t.eventName,t.handler,false)};if(!t&&!e&&!i){n.forEach(s);this._handlers=[]}else{n.filter(function(r){return r.eventName===t&&(i?r.callback===i:true)&&(e?r.selector===e:true)}).forEach(function(t){s(t);n.splice(n.indexOf(t),1)})}},delegateEvents:function(e,i){if(!(e||(e=t.result(this,"events"))))return this;if(!i)this.undelegateEvents();for(var r in e){var n=e[r];if(typeof n!=="function")n=this[e[r]];var s=r.match(N);var o=s[1],u=s[2];if(a.$){o+=".delegateEvents"+this.cid;n=n.bind(this);this.$el.on(o,u?u:null,n)}else{this.delegate(o,u,n)}}return this},undelegateEvents:function(){if(a.$){this.$el.off(".delegateEvents"+this.cid)}else{this.undelegate()}return this},_ensureElement:function(){if(!this.el){var e=t.extend({},t.result(this,"attributes"));if(this.id)e.id=t.result(this,"id");if(this.className)e.className=t.result(this,"className");if(e["class"])e.className=e["class"];var i=t.extend(document.createElement(t.result(this,"tagName")),e);this.setElement(i,false)}else{this.setElement(t.result(this,"el"),false)}}});a.sync=function(e,i,r){var n=P[e];t.defaults(r||(r={}),{emulateHTTP:a.emulateHTTP,emulateJSON:a.emulateJSON});var s={type:n,dataType:"json"};if(!r.url){s.url=t.result(i,"url")||f()}if(r.data==null&&i&&(e==="create"||e==="update"||e==="patch")){s.contentType="application/json";s.data=JSON.stringify(r.attrs||i.toJSON(r))}if(r.emulateJSON){s.contentType="application/x-www-form-urlencoded";s.data=s.data?{model:s.data}:{}}if(r.emulateHTTP&&(n==="PUT"||n==="DELETE"||n==="PATCH")){s.type="POST";if(r.emulateJSON)s.data._method=n;var o=r.beforeSend;r.beforeSend=function(t){t.setRequestHeader("X-HTTP-Method-Override",n);if(o)return o.apply(this,arguments)}}if(s.type!=="GET"&&!r.emulateJSON){s.processData=false}var u=r.xhr=a.ajax(t.extend(s,r));i.trigger("request",i,u,r);return u};var P={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};a.ajax=a.$?function(){return a.$.ajax.apply(a.$,arguments)}:o.ajax;if(a.$)a.Deferred=function(){return new a.$.Deferred};var C=a.Router=function(t){t||(t={});if(t.routes)this.routes=t.routes;this._bindRoutes();this.initialize.apply(this,arguments)};var I=/\((.*?)\)/g;var R=/(\(\?)?:\w+/g;var q=/\*\w+/g;var U=/[\-{}\[\]+?.,\\\^$|#\s]/g;var L=function(t){return t?typeof t==="object"&&c.call(t)==="[object RegExp]":false};t.extend(C.prototype,y,{initialize:function(){},route:function(t,e,i){if(!L(t))t=this._routeToRegExp(t);if(typeof e==="function"){i=e;e=""}if(!i)i=this[e];var r=this;a.history.route(t,function(n){var s=r._extractParameters(t,n);i&&i.apply(r,s);r.trigger.apply(r,["route:"+e].concat(s));r.trigger("route",e,s);a.history.trigger("route",r,e,s)});return this},navigate:function(t,e){a.history.navigate(t,e);return this},_bindRoutes:function(){if(!this.routes)return;this.routes=t.result(this,"routes");var e,i=Object.keys(this.routes);while((e=i.pop())!=null){this.route(e,this.routes[e])}},_routeToRegExp:function(t){t=t.replace(U,"\\$&").replace(I,"(?:$1)?").replace(R,function(t,e){return e?t:"([^/]+)"}).replace(q,"(.*?)");return new RegExp("^"+t+"$")},_extractParameters:function(t,e){var i=t.exec(e).slice(1);return i.map(function(t){return t?decodeURIComponent(t):null})}});var M=a.History=function(){this.handlers=[];this.checkUrl=this.checkUrl.bind(this);if(typeof window!=="undefined"){this.location=window.location;this.history=window.history}};var J=/^[#\/]|\s+$/g;var B=/^\/+|\/+$/g;var z=/\/$/;var D=/[#].*$/;M.started=false;t.extend(M.prototype,y,{getHash:function(t){var e=(t||this).location.href.match(/#(.*)$/);return e?e[1]:""},getFragment:function(t){if(t==null){if(this._wantsPushState||!this._wantsHashChange){t=this.location.pathname+this.location.search;var e=this.root.replace(z,"");if(!t.indexOf(e))t=t.slice(e.length)}else{t=this.getHash()}}return t.replace(J,"")},start:function(e){if(M.started)throw new Error("Backbone.history has already been started");M.started=true;this.options=t.extend({root:"/"},this.options,e);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;var i=this.getFragment();this.root=("/"+this.root+"/").replace(B,"/");if(this._wantsPushState){window.addEventListener("popstate",this.checkUrl,false)}else if(this._wantsHashChange){window.addEventListener("hashchange",this.checkUrl,false)}this.fragment=i;var r=this.location;var n=r.pathname.replace(/[^\/]$/,"$&/")===this.root;if(this._wantsHashChange&&this._wantsPushState){if(n&&r.hash){this.fragment=this.getHash().replace(J,"");this.history.replaceState({},document.title,this.root+this.fragment)}}if(!this.options.silent)return this.loadUrl()},stop:function(){window.removeEventListener("popstate",this.checkUrl);window.removeEventListener("hashchange",this.checkUrl);M.started=false},route:function(t,e){this.handlers.unshift({route:t,callback:e})},checkUrl:function(){var t=this.getFragment();if(t===this.fragment)return false;this.loadUrl()},loadUrl:function(t){t=this.fragment=this.getFragment(t);return this.handlers.some(function(e){if(e.route.test(t)){e.callback(t);return true}})},navigate:function(t,e){if(!M.started)return false;if(!e||e===true)e={trigger:!!e};var i=this.root+(t=this.getFragment(t||""));t=t.replace(D,"");if(this.fragment===t)return;this.fragment=t;if(t===""&&i!=="/")i=i.slice(0,-1);if(this._wantsPushState){this.history[e.replace?"replaceState":"pushState"]({},document.title,i)}else if(this._wantsHashChange){this._updateHash(this.location,t,e.replace)}else{return this.location.assign(i)}if(e.trigger)return this.loadUrl(t)},_updateHash:function(t,e,i){if(i){var r=t.href.replace(/(javascript:|#).*$/,"");t.replace(r+"#"+e)}else{t.hash="#"+e}}});["Model","Collection","Router","View","History"].forEach(function(t){var e=a[t];if(e)e.extend=a.extend});t.extend(a,y);a.history=new M;return a});